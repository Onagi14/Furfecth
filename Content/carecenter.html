<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FurFect Match - Care Center</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #fffbe9;
  --sidebar: #f7d79e;
  --highlight: #f78c56;
  --card-bg: #c5b7e9;
  font-family: 'Poppins', sans-serif;
}
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  display: flex;
  min-height: 100vh;
  background: var(--bg);
  color: #111114;
  transition: all 0.3s ease;
}

/* Sidebar */
.sidebar {
  background: var(--sidebar);
  width: 220px;
  padding: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
  transition: all 0.3s ease;
}
.logo { text-align: center; font-weight: bold; margin-bottom: 20px; font-size: 18px; }
.logo span { color: red; }

.profile-wrapper { position: relative; width: 90px; height: 90px; margin-bottom: 10px; }
.profile-wrapper img { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; border: 2px solid #333; }
.upload-btn {
  position: absolute; bottom: 0; right: 0;
  background: var(--highlight); color: white;
  width: 24px; height: 24px; border-radius: 50%;
  display: flex; justify-content: center; align-items: center;
  font-size: 16px; font-weight: bold; cursor: pointer; border: 2px solid #fff;
}
#profileInput { display: none; }

.username { font-weight: 600; margin-bottom: 20px; text-align: center; cursor: pointer; }

.menu { width: 100%; flex-grow: 1; }
.menu a {
  display: block; padding: 10px; text-decoration: none;
  color: #111114; font-weight: 500; border-bottom: 1px solid black;
}
.menu a.active { color: var(--highlight); font-weight: 600; }

.logout-btn {
  display: block;
  width: 100%;
  padding: 10px;
  margin-top: 10px;
  text-align: center;
  text-decoration: none;
  color: #111114;
  background: #f78c56;
  border-radius: 8px;
  font-weight: 600;
}
.logout-btn:hover { background: #f55c2b; color: white; }

/* Topbar */
.topbar {
  background: #c5b7e9;
  display: flex;
  justify-content: flex-start;
  align-items: center;
  padding: 12px 20px;
}
.topbar .menu-btn { font-size: 22px; cursor: pointer; display: none; }

/* Main */
.main { flex: 1; display: flex; flex-direction: column; align-items: center; }
.content { padding: 40px 20px; text-align: center; width: 100%; }
.content h2 { margin-bottom: 10px; }
.content p { margin-bottom: 20px; color: #333; }

/* Pet selection */
.pet-selection img {
  width: 200px;  
  height: auto;
  margin: 15px;
  cursor: pointer;
  border-radius: 20px;
  border: 2px solid transparent;
  transition: all 0.3s ease;
}
.pet-selection img:hover { border-color: var(--highlight); transform: scale(1.1); }

.game-container {
  position: relative; 
  width: 300px; 
  height: 400px;
  border: 4px solid #333; 
  border-radius: 20px;
  background-size: cover;
  overflow: hidden;
  margin: 20px auto; 
  display: none;
}

.place-controls {
  display: flex;
  justify-content: space-between;
  position: absolute;
  width: 100%;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
}
.place-controls button {
  pointer-events: all;
  background: rgba(0,0,0,0.5);
  color: white;
  border: none;
  font-size: 20px;
  border-radius: 50%;
  width: 40px; height: 40px;
  cursor: pointer;
}
.place-controls button:hover { background: rgba(0,0,0,0.8); }

.pet { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 200px; transition: all 0.5s ease; }
.food { position: absolute; width: 60px; top: 20px; left: 20px; cursor: grab; user-select: none; }


#petSelection {
  display: flex; /* show by default */
  justify-content: center;
}


/* Status */
.status-bar {
  position: absolute;
  right: 10px;
  bottom: 40px;   /* move it down */
  width: 20px;
  height: 120px;  /* shorter bar */
  border: 2px solid #333;
  border-radius: 10px;
  background: #eee;
  overflow: hidden;
}

.status-fill {
  position: absolute; bottom: 0; width: 100%; height: 0%;
  background: #4caf50; transition: height 0.3s ease;
}
.level-label {
  position: absolute; top: 10px; right: 10px;
  font-weight: 600; background: #f78c56; color: white;
  padding: 5px 10px; border-radius: 8px;
}

/* Wash bubbles */
.bubbles { position: absolute; width: 100%; height: 100%; pointer-events: none; overflow: hidden; }
.bubble { position: absolute; bottom: 0; width: 20px; height: 20px; border-radius: 50%; background: rgba(173, 216, 230, 0.7); animation: rise 3s linear infinite; }
@keyframes rise { from { transform: translateY(0) scale(1); opacity:1;} to { transform: translateY(-400px) scale(0.5); opacity:0;} }

/* Soccer ball */
.soccer-ball {
  position: absolute;
  bottom: 80px;
  left: 120px;
  width: 50px;
  height: 50px;
  background: url("images/soccerball.png") no-repeat center/cover;
  animation: bounce 1s ease-in-out infinite;
}
@keyframes bounce { 0%,100% { transform: translateY(0);} 50% { transform: translateY(-120px);} }

/* Controls */
.controls { margin-top: 20px; display: none; }  
button.action {
  padding: 10px 20px; margin: 0 10px;
  font-size: 16px; border: none; border-radius: 8px;
  background: #4CAF50; color: white; cursor: pointer;
}
button.action:hover { background: #45a049; }

#lightBtn {
  margin-top: 10px;
  padding: 8px 15px;
  border: none;
  border-radius: 8px;
  background: #ffcc00;
  font-weight: 600;
  cursor: pointer;
  display: none;
}


.status-container {
  position: absolute;
  right: 10px;   /* keep it inside game box */
  top: 50px;
  width: 120px;
}

.status-row {
  margin: 10px 0;
}

.bar {
  width: 100%;
  height: 18px;
  border: 2px solid #333;
  border-radius: 10px;
  background: #eee;
  overflow: hidden;
}

.bar div {
  height: 100%;
  width: 50%; /* default */
  transition: width 0.3s ease;
}

#hungerBar { background: #f78c56; }
#energyBar { background: #4caf50; }







/* Mobile */
@media (max-width: 768px) {
  body { flex-direction: column; }
  .sidebar {
    position: absolute; left: -250px; top: 0; height: 100%; z-index: 1000;
  }
  .sidebar.open { left: 0; }
  .topbar .menu-btn { display: block; }
  .close-btn {
    display: block; position: absolute; top: 10px; right: 10px;
    background: var(--highlight); color: #fff; font-size: 18px; font-weight: bold;
    width: 28px; height: 28px; border-radius: 50%; text-align: center; line-height: 28px; cursor: pointer;
  }
}
@media (min-width: 769px) { .close-btn { display: none; } }
</style>
</head>
<body>

<div class="sidebar" id="sidebar">
  <div class="close-btn" onclick="toggleSidebar()">Ã—</div>
  <div class="logo">FUR<span>FECT</span> MATCH</div>
  <div class="profile-wrapper">
    <img id="profilePic" src="https://cdn-icons-png.flaticon.com/512/847/847969.png">
    <div class="upload-btn" onclick="document.getElementById('profileInput').click()">+</div>
    <input type="file" id="profileInput" accept="image/*">
  </div>
  <div class="username" id="username" title="Click to change">USERNAME</div>
  <div class="menu">
    <a href="dashboard.html">Dashboard</a>
    <a href="carecenter.html" class="active">Care Center</a>
    <a href="adoptioncenter.html">Adoption Center</a>
    <a href="community.html"  >Community Chat</a>
    <a href="guide.html">Guides</a>
    <a href="#" class="logout-btn" onclick="logout()">ðŸ”Œ Logout</a>

  </div>
</div>

<div class="main">
  <div class="topbar"><div class="menu-btn" onclick="toggleSidebar()">â˜°</div></div>

  <div class="content">
    <h2>CARE CENTER - Virtual Pet Game</h2>
    <p>Choose a pet to start caring for!</p>

    <div class="pet-selection" id="petSelection" style="display:none;">
      <img src="images/cat_baby.png" alt="Cat" data-type="cat">
      <img src="images/dog_baby.png" alt="Dog" data-type="dog">
    </div>

    <div class="game-container" id="gameContainer">
      <div class="place-controls">
        <button id="prevPlace">âŸ¨</button>
        <button id="nextPlace">âŸ©</button>
      </div>
      <img id="petImage" class="pet" src="">
      <img src="images/fish.png" class="food" id="food">
      <div class="bubbles" id="bubbles"></div>
      <div class="status-bar"><div class="status-fill" id="statusFill"></div></div>
      <div class="level-label" id="levelLabel">Level: 1</div>
      <button id="lightBtn">Lights Off</button>



      
    <div class="status-container">
  <div class="status-row">
    <label>Hunger</label>
    <div class="bar"><div id="hungerBar"></div></div>
  </div>
  <div class="status-row">
    <label>Energy</label>
    <div class="bar"><div id="energyBar"></div></div>
  </div>
</div>
    </div>






    <div class="controls" id="controls">
      <button class="action" id="washBtn" onclick="washPet()" style="display:none;">Wash</button>
      <button class="action" id="playBtn" style="display:none;" onclick="playSoccer()">Play</button>
    </div>
  </div>
</div>

<script>
function toggleSidebar(){ document.getElementById('sidebar').classList.toggle('open'); }

// Background places
const places=["images/kitchen.jpg","images/bathroom.jpg","images/outside.jpg","images/bedroom.jpg"];
let currentPlace=0;
const gameContainer=document.getElementById("gameContainer");
const playBtn=document.getElementById("playBtn");
const washBtn=document.getElementById("washBtn");
const food=document.getElementById("food");
const lightBtn=document.getElementById("lightBtn");

let lightsOn=true;

document.getElementById("prevPlace").addEventListener("click",()=>{currentPlace=(currentPlace-1+places.length)%places.length;changePlace();});
document.getElementById("nextPlace").addEventListener("click",()=>{currentPlace=(currentPlace+1)%places.length;changePlace();});
document.querySelectorAll(".soccer-ball").forEach(b=>b.remove());



function changePlace(){
  // Always remove soccer ball when changing place
  document.querySelectorAll(".soccer-ball").forEach(b=>b.remove());

  lightsOn=true;
  lightBtn.textContent="Lights Off";
  lightBtn.style.display="none";

  gameContainer.style.background=`url(${places[currentPlace]}) no-repeat center center`;
  gameContainer.style.backgroundSize="cover";

  if(places[currentPlace].includes("kitchen")){
    food.style.display="block"; washBtn.style.display="none"; playBtn.style.display="none";
  } 
  else if(places[currentPlace].includes("bathroom")){
    food.style.display="none"; washBtn.style.display="inline-block"; playBtn.style.display="none";
  }
  else if(places[currentPlace].includes("outside")){
    food.style.display="none"; washBtn.style.display="none"; playBtn.style.display="inline-block";
  }
  else if(places[currentPlace].includes("bedroom")){
    food.style.display="none"; washBtn.style.display="none"; playBtn.style.display="none";
    lightBtn.style.display="block";
  }
  updatePetImage();
}


lightBtn.addEventListener("click", () => {
  if (lightsOn) {
    // turn lights off
    lightsOn = false;
    lightBtn.textContent = "Lights On";
    gameContainer.style.background = "url('images/bedroom-night.jpg') no-repeat center/cover";
    updatePetImage(true); // sleeping pet

    // start recharging energy while sleeping
    let sleepInterval = setInterval(() => {
      if (lightsOn) { clearInterval(sleepInterval); return; } // stop if lights back on
      energy = Math.min(100, energy + 5); // recharge slowly
      updateBars();
    }, 3000);
  } else {
    // turn lights back on
    lightsOn = true;
    lightBtn.textContent = "Lights Off";
    gameContainer.style.background = "url('images/bedroom.jpg') no-repeat center/cover";
    updatePetImage(false); // awake pet
  }
});


// Profile handling
const usernameEl=document.getElementById("username");
const profilePic=document.getElementById("profilePic");
const profileInput=document.getElementById("profileInput");
usernameEl.textContent=sessionStorage.getItem('username')||"USERNAME";
const savedProfilePic = sessionStorage.getItem('profilePic');
if (savedProfilePic) {
  profilePic.src = savedProfilePic;
} else {
  profilePic.src = "https://cdn-icons-png.flaticon.com/512/847/847969.png"; // default
}

usernameEl.addEventListener("click",()=>{const newName=prompt("Enter username:",usernameEl.textContent);if(newName){usernameEl.textContent=newName;sessionStorage.setItem('username',newName);}});
profileInput.addEventListener("change",(e)=>{const file=e.target.files[0];if(file){const reader=new FileReader();reader.onload=()=>{profilePic.src=reader.result;sessionStorage.setItem('profilePic',reader.result)};reader.readAsDataURL(file);}});

// Pet game
const petSelection=document.getElementById("petSelection");
const petImage=document.getElementById("petImage");
const bubbles=document.getElementById("bubbles");
const statusFill=document.getElementById("statusFill");
const levelLabel=document.getElementById("levelLabel");
const controls=document.getElementById("controls");

let petType="",level=1,exp=0;



  let hunger = 50;  // 0 = starving, 100 = full
let energy = 100; // 0 = exhausted, 100 = fully energized
const hungerBar = document.getElementById("hungerBar");
const energyBar = document.getElementById("energyBar");

function updateBars() {
  hungerBar.style.width = hunger + "%";
  energyBar.style.width = energy + "%";
  
  
  // âœ… restore exp progress correctly
  statusFill.style.height = (exp / 100) * 100 + "%"; // or (exp) + "%" if max = 100
}

updateBars();


// Slowly decrease hunger over time
setInterval(() => {
  if (hunger > 0) {
    hunger = Math.max(0, hunger - 5); // decrease by 1
    updateBars();

    if (hunger === 0) {
      console.log("Your pet is starving!");
      // optional: alert("Your pet is starving! Feed it!");
    }
  }
}, 3000); // every 3 seconds




petSelection.querySelectorAll("img").forEach(img=>{
  img.addEventListener("click",()=>{
    petType=img.dataset.type;
    petSelection.style.display="none";
    gameContainer.style.display="block";
    controls.style.display="block"; 
    if(petType==="cat") food.src="images/fish.png"; else food.src="images/bone.png";
    updatePetImage(); updateLevel(); changePlace();
    savePet();  // <--- save first selectio
  });
});

food.addEventListener("mousedown",e=>{food.dragging={offsetX:e.offsetX,offsetY:e.offsetY};food.style.cursor="grabbing";});
document.addEventListener("mousemove",e=>{
  if(food.dragging){
    const rect=gameContainer.getBoundingClientRect();
    let x=e.clientX-rect.left-food.dragging.offsetX;
    let y=e.clientY-rect.top-food.dragging.offsetY;
    x=Math.max(0,Math.min(rect.width-food.offsetWidth,x));
    y=Math.max(0,Math.min(rect.height-food.offsetHeight,y));
    food.style.left=x+"px";food.style.top=y+"px";
  }
});
document.addEventListener("mouseup",()=>{
  if(food.dragging){
    food.dragging=null; food.style.cursor="grab";
    const rect=gameContainer.getBoundingClientRect();
    const foodRect=food.getBoundingClientRect();
    const dropX=foodRect.left+foodRect.width/2-rect.left;
    const dropY=foodRect.top+foodRect.height/2-rect.top;
    if(dropY>250&&dropX>50&&dropX<250) feedPet();
  }
});
function feedPet() {
  if (hunger >= 100) {
    // show disgusting face if too full
    let disgustingImage = "";
    if (level < 11) disgustingImage = `images/${petType}disgusting_baby.png`;
    else if (level < 21) disgustingImage = `images/${petType}disgusting_grow.png`;
    else disgustingImage = `images/${petType}disgusting_adult.png`;

    petImage.src = disgustingImage;

    // revert to normal
    setTimeout(() => { updatePetImage(); }, 2000);
    return;
  }

  // eating image
  let eatingImage = "";
  if (level < 11) eatingImage = `images/${petType}eating_baby.png`;
  else if (level < 21) eatingImage = `images/${petType}eating_grow.png`;
  else eatingImage = `images/${petType}eating_adult.png`;

  petImage.src = eatingImage;

  setTimeout(() => { updatePetImage(); }, 1000);

  exp += 10;
  hunger = Math.min(100, hunger + 20);
  updateBars();
  savePet();

  if (exp >= 100) {
    level++;
    exp = 0;
    updatePetImage();
    updateLevel();
    savePet();
  }
  statusFill.style.height = exp + "%";

  food.style.left = "20px";
  food.style.top = "20px";
}


function updateLevel(){levelLabel.textContent="Level: "+level;}

function washPet(){
  for(let i=0;i<10;i++){
    let b=document.createElement("div");b.classList.add("bubble");
    b.style.left=Math.random()*280+"px"; b.style.animationDuration=(2+Math.random()*2)+"s";
    bubbles.appendChild(b); setTimeout(()=>b.remove(),4000);
  }
}

function playSoccer(){
  if (energy <= 0) {
    alert("Your pet is too tired to play!");
    return;
  }

  energy = Math.max(0, energy - 20); // drains energy
  updateBars();
  savePet();   // <--- save after update

  document.querySelectorAll(".soccer-ball").forEach(b=>b.remove());
  const ball=document.createElement("div");
  ball.classList.add("soccer-ball");
  gameContainer.appendChild(ball);
  setTimeout(()=>{ball.remove();},6000);
}



// Load user data
async function loadUser() {
  const email = sessionStorage.getItem("userEmail");
  if (!email) return;
  try {
    const res = await fetch(`https://furfecth.onrender.comapi/user?email=${email}`);
    const data = await res.json();
   if (data.success) {
  document.getElementById("username").textContent = data.firstName;
  if (data.profileImage && !data.profileImage.includes("undefined")) {
    document.getElementById("profilePic").src = data.profileImage;
  } else {
    document.getElementById("profilePic").src = "https://cdn-icons-png.flaticon.com/512/847/847969.png";
  }
}

  } catch (err) { console.error("Error fetching user:", err); }
}

// Upload new profile image
document.getElementById("profileInput").addEventListener("change", async function () {
  const file = this.files[0];
  if (!file) return;

  const email = sessionStorage.getItem("userEmail");
  if (!email) return alert("No email found in localStorage!");

  const formData = new FormData();
  formData.append("profileImage", file);
  formData.append("email", email);

  try {
    const res = await fetch("https://furfecth.onrender.com/api/upload-profile", {
      method: "POST",
      body: formData
    });

    const data = await res.json();
    if (data.success) {
      document.getElementById("profilePic").src = data.profileImage;
      alert("Profile picture updated!");
    } else {
      alert("Failed to upload profile picture.");
    }
  } catch (err) {
    console.error("Upload error:", err);
  }
});



async function loadPet() {
  const email = sessionStorage.getItem("userEmail");
  if (!email) return;

  let petFound = false;

  try {
    // Try loading from backend
    const res = await fetch(`https://furfecth.onrender.com/api/get-pet?email=${email}`);
    const data = await res.json();

    if (data.success && data.pet && data.pet.type) {
      petFound = true;
      petType = data.pet.type;
      level = data.pet.level;
      hunger = data.pet.hunger;
      energy = data.pet.energy;
      exp = data.pet.exp;
    }
  } catch (err) {
    console.error("Error fetching pet:", err);
  }

  // If no pet from backend, try localStorage
  if (!petFound) {
    const savedPet = JSON.parse(sessionStorage.getItem("petData"));
    if (savedPet && savedPet.type) {
      petFound = true;
      petType = savedPet.type;
      level = savedPet.level;
      hunger = savedPet.hunger;
      energy = savedPet.energy;
      exp = savedPet.exp;
    }
  }

  // âœ… Decide what to show
  if (petFound) {
    // Show game
    petSelection.style.display = "none";
    gameContainer.style.display = "block";
    controls.style.display = "block";
    food.src = petType === "cat" ? "images/fish.png" : "images/bone.png";

    updatePetImage();
    updateBars();
    updateLevel();
    changePlace();
  } else {
    // Show selection screen
    petSelection.style.display = "flex"; // or "block"
    gameContainer.style.display = "none";
    controls.style.display = "none";
  }
}



async function savePet() {
  const email = sessionStorage.getItem("userEmail");
  if (!email || !petType) return;

  const petData = { type: petType, level, exp, hunger, energy, name: sessionStorage.getItem("petName") || "My Pet" };
  sessionStorage.setItem("petData", JSON.stringify(petData));

  console.log("â†’ saving pet to server:", email, petData);
  try {
    const res = await fetch("https://furfecth.onrender.com/api/save-pet", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, pet: petData })
    });
    const json = await res.json();
    console.log("â† save-pet response:", json);
  } catch (err) {
    console.error("Error saving pet to server:", err);
  }
}

function updatePetImage(isSleeping = false) {
  let stage = "baby";
  if (level >= 11 && level <= 20) stage = "grow";
  else if (level >= 21) stage = "adult";

  let imgPath;
  if (isSleeping) {
    imgPath = `images/${petType}sleeping_${stage}.png`;
  } else {
    // âœ… this uses your plain cat_baby.png / dog_baby.png
    imgPath = `images/${petType}_${stage}.png`;
  }

  // if no petType, don't write a petData (avoids creating a false saved pet)
  if (!petType) {
    petImage.src = ""; // or a default placeholder
    return;
  }

  petImage.src = imgPath;
  const petData = JSON.parse(sessionStorage.getItem("petData")) || {};
  petData.type = petType;
  petData.image = imgPath;
  petData.level = level;
  sessionStorage.setItem("petData", JSON.stringify(petData));

}




window.onload = async () => {
  loadUser();

  // First try backend (preferred)
  await loadPet(); // ensure loadPet finishes and sets petFound if backend has a pet

  // If loadPet didn't set petType, try localStorage fallback
  if (!petType) {
    const savedPet = JSON.parse(sessionStorage.getItem("petData"));
    if (savedPet && savedPet.type) {
      petType = savedPet.type;
      level = savedPet.level || 1;
      hunger = savedPet.hunger || 50;
      energy = savedPet.energy || 100;
      exp = savedPet.exp || 0;
      petSelection.style.display = "none";
      gameContainer.style.display = "block";
      controls.style.display = "block";
      food.src = petType === "cat" ? "images/fish.png" : "images/bone.png";
      updatePetImage();
      updateBars();
      updateLevel();
      changePlace();
    } else {
      // No pet anywhere -> show selection
      petSelection.style.display = "flex";
      gameContainer.style.display = "none";
      controls.style.display = "none";
    }
  } else {
    // backend set petType, UI already shown in loadPet()
  }
};

function logout() {
  // Clear local storage (user data, pet data, token, etc.)
  sessionStorage.removeItem("userEmail");
  sessionStorage.removeItem("username");
  sessionStorage.removeItem("profilePic");
  sessionStorage.removeItem("petData");
  sessionStorage.removeItem("petName");
  sessionStorage.removeItem("token"); // if you use JWT

  // Optional: clear everything
  // localStorage.clear();

  // Redirect back to login page
  window.location.href = "login.html";
}



</script>
</body>
</html>
