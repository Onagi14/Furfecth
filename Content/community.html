<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FurFect Match - Community Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #fffbe9;
  --sidebar: #f7d79e;
  --highlight: #f78c56;
  --card-bg: #d2c5f5;
  --chat-bg: #fef9e7;
  font-family: 'Poppins', sans-serif;
}
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  display: flex;
  min-height: 100vh;
  background: var(--bg);
  color: #111114;
}

/* Sidebar */
.sidebar {
  background: var(--sidebar);
  width: 220px;
  padding: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.logo { text-align: center; font-weight: bold; margin-bottom: 20px; font-size: 18px; }
.logo span { color: red; }

.profile-wrapper { position: relative; width: 90px; height: 90px; margin-bottom: 10px; }
.profile-wrapper img { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; border: 2px solid #333; }
.upload-btn {
  position: absolute; bottom: 0; right: 0;
  background: var(--highlight); color: white;
  width: 24px; height: 24px; border-radius: 50%;
  display: flex; justify-content: center; align-items: center;
  font-size: 16px; font-weight: bold; cursor: pointer; border: 2px solid #fff;
}
#profileInput { display: none; }

.username { font-weight: 600; margin-bottom: 20px; text-align: center; }

.menu { width: 100%; flex-grow: 1; }
.menu a {
  display: block;
  padding: 10px;
  text-decoration: none;
  color: #111114;
  border-bottom: 1px solid black;
}
.menu a.active { color: var(--highlight); font-weight: 600; }
.logout-btn {
  background: var(--highlight);
  color: #fff;
  text-align: center;
  border-radius: 8px;
  padding: 10px;
  text-decoration: none;
  font-weight: 600;
  margin-top: 10px;
}

/* Chat section */
.main { flex: 1; display: flex; flex-direction: column; }

.topbar {
  background: #c5b7e9;
  padding: 12px 20px;
  font-weight: 600;
  color: #333;
}
.chat-container {
  background: var(--chat-bg);
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  padding: 20px;
  border-radius: 15px;
  margin: 20px;
  height: 80vh; /* üëà Fixed height for the whole chat area */
  max-height: 80vh;
}

.chat-messages {
  flex-grow: 1;
  overflow-y: auto;
  scroll-behavior: smooth;
  padding: 10px;
  border: 2px solid #f7d79e;
  border-radius: 10px;
  background: #fff;
  margin-bottom: 10px;
  height: 100%;
  max-height: calc(100% - 70px); /* üëà Keeps chat area fixed even with input below */
}


.message {
  display: flex;
  align-items: flex-start;
  margin-bottom: 12px;
  max-width: 80%;
  word-wrap: break-word;
  gap: 8px;
}

.message.user {
  align-self: flex-end;
  flex-direction: row-reverse;
}

.message .profile-pic {
  width: 36px; height: 36px; border-radius: 50%; object-fit: cover;
}

.message-content {
  background: #d2c5f5;
  border-radius: 10px;
  padding: 8px 12px;
}
.message.user .message-content {
  background: #b8f2a5;
}
.message .sender {
  font-size: 13px;
  font-weight: 600;
  color: #555;
  margin-bottom: 4px;
}
.message .text {
  font-size: 14px;
}

.chat-input {
  display: flex;
  gap: 10px;
}
.chat-input input {
  flex: 1;
  padding: 10px;
  border-radius: 10px;
  border: 2px solid #f7d79e;
}
.chat-input button {
  background: var(--highlight);
  color: white;
  border: none;
  border-radius: 10px;
  padding: 10px 20px;
  font-weight: bold;
  cursor: pointer;
}
.chat-input button:hover { background: #f55c2b; }


.chat-messages::-webkit-scrollbar {
  width: 8px;
}
.chat-messages::-webkit-scrollbar-thumb {
  background: var(--highlight);
  border-radius: 10px;
}
.chat-messages::-webkit-scrollbar-track {
  background: #f9e9d0;
}
.chat-input button#imageBtn {
  background: #ccc;
  color: #333;
  border: none;
  border-radius: 10px;
  padding: 10px 12px;
  cursor: pointer;
}
.chat-input button#imageBtn:hover {
  background: #bbb;
}
.message-content img.chat-img {
  max-width: 200px;
  max-height: 200px;
  border-radius: 8px;
  display: block;
  margin-top: 6px;
}


</style>
</head>
<body>

<div class="sidebar">
  <div class="logo">FUR<span>FECT</span> MATCH</div>
  <div class="profile-wrapper">
    <img id="profilePic" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="Profile">
    <div class="upload-btn" onclick="document.getElementById('profileInput').click()">+</div>
    <input type="file" id="profileInput" accept="image/*">
  </div>
  <div class="username" id="username">USERNAME</div>
  <div class="menu">
    <a href="dashboard.html">Dashboard</a>
    <a href="carecenter.html">Care Center</a>
    <a href="adoptioncenter.html">Adoption Center</a>
    <a href="community.html" class="active">Community Chat</a>
    <a href="guide.html">Guides</a>
    <a href="#" class="logout-btn" onclick="logout()">üîå Logout</a>
  </div>
</div>

<div class="main">
  <div class="topbar">üêæ Community Chatroom</div>

  <div class="chat-container">
    <div id="chatMessages" class="chat-messages"></div>
        <div class="chat-input">
  <input type="text" id="chatInput" placeholder="Type a message..." />
  <input type="file" id="chatImageInput" accept="image/*" style="display:none" />
  <button type="button" id="imageBtn">üìé</button>
  <button type="button" id="sendBtn">Send</button>
</div>

  </div>
</div>

<script src="http://localhost:5000/socket.io/socket.io.js"></script>
<script>
const socket = io("http://localhost:5000");
const messagesDiv = document.getElementById("chatMessages");
const messageInput = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendBtn");

const userEmail = sessionStorage.getItem("userEmail") || "Anonymous";
let userProfile = "https://cdn-icons-png.flaticon.com/512/847/847969.png";
let userName = "User";

// üü¢ Load user data
async function loadUser() {
  if (!userEmail) return;
  try {
    const res = await fetch(`http://localhost:5000/api/user?email=${userEmail}`);
    const data = await res.json();
    if (data.success) {
      userName = data.firstName;
      if (data.profileImage) userProfile = data.profileImage;
      document.getElementById("username").textContent = userName;
      document.getElementById("profilePic").src = userProfile;
    }
  } catch (err) {
    console.error("Error fetching user:", err);
  }
}
loadUser();
// üü¢ Load previous messages
async function loadMessages() {
  try {
    const res = await fetch("http://localhost:5000/api/messages");
    const data = await res.json();

    messagesDiv.innerHTML = "";
    data.forEach(msg => addMessage(msg));
    autoScroll();
  } catch (err) {
    console.error("Failed to load messages", err);
  }
}


// üí¨ Create message element
function addMessage(msg) {
  const div = document.createElement("div");
  div.classList.add("message", msg.sender === userEmail ? "user" : "other");

  const img = document.createElement("img");
  img.src = msg.profile || "https://cdn-icons-png.flaticon.com/512/847/847969.png";
  img.classList.add("profile-pic");

  const content = document.createElement("div");
  content.classList.add("message-content");

  const sender = document.createElement("div");
  sender.classList.add("sender");
  sender.textContent = msg.name || msg.sender;

  const text = document.createElement("div");
  text.classList.add("text");
  text.textContent = msg.message;

  content.appendChild(sender);
  content.appendChild(text);

  // ‚úÖ If there's an image message, show it
  if (msg.image) {
    const imageEl = document.createElement("img");
    imageEl.src = msg.image;
    imageEl.classList.add("chat-img");
    content.appendChild(imageEl);
  }

  div.appendChild(img);
  div.appendChild(content);
  messagesDiv.appendChild(div);
}

// üß≠ Auto scroll
function autoScroll() {
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}



// üü¢ Handle image upload button
document.getElementById("imageBtn").addEventListener("click", () => {
  document.getElementById("chatImageInput").click();
});

// üü¢ When image selected, send to chat
document.getElementById("chatImageInput").addEventListener("change", function () {
  const file = this.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    const base64Image = reader.result; // data:image/png;base64,xxx
    const msgObj = {
      sender: userEmail,
      name: userName,
      profile: userProfile,
      message: "(üì∑ Image sent)",
      image: base64Image
    };
    socket.emit("chatMessage", msgObj);
  };
  reader.readAsDataURL(file);
});

loadMessages();

// üü° Receive real-time messages
socket.on("chatMessage", (msg) => {
  addMessage(msg);
  setTimeout(autoScroll, 100); // ensures smooth scrolling even with image load delay
});

// üîµ Send message
sendBtn.addEventListener("click", () => {
  const message = messageInput.value.trim();
  if (message) {
    const msgObj = { sender: userEmail, name: userName, profile: userProfile, message };
    socket.emit("chatMessage", msgObj);
    messageInput.value = "";
  }
});
messageInput.addEventListener("keypress", (e) => {
  if (e.key === "Enter") sendBtn.click();
});

// üßç‚Äç‚ôÇÔ∏è Upload profile pic
document.getElementById("profileInput").addEventListener("change", async function () {
  const file = this.files[0]; if (!file) return;
  const formData = new FormData();
  formData.append("profileImage", file);
  formData.append("email", userEmail);
  try {
    const res = await fetch("http://localhost:5000/api/upload-profile", { method: "POST", body: formData });
    const data = await res.json();
    if (data.success) {
      document.getElementById("profilePic").src = data.profileImage;
      userProfile = data.profileImage;
    }
  } catch (err) {
    console.error("Upload error:", err);
  }
});

function logout() {
  sessionStorage.clear();
  window.location.href = "login.html";
}
</script>
</body>
</html>
